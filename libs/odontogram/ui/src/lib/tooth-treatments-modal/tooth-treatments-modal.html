<div class="modal-header">
  <h4 class="modal-title">Tooth {{tooth().number}}</h4>
  @if (client()) {
  <button mat-stroked-button class="button-primary-general" (click)="toggleHistory()">
    <span class="content">
      <i class="fas fa-plus"></i>
      <span>Show treatment history</span>
    </span>
  </button>
  }
  <button mat-stroked-button class="button-primary-save" tooltip="Save" (click)="saveTooth()"
    [disabled]="selectedTooth?.odontogram !== tooth().odontogram">
    Save
    <i class="ml-2 fas fa-floppy-disk"></i>
  </button>
  <button mat-icon-button>
    <i class="fas fa-times"></i>
  </button>
</div>
<div class="modal-body" [formGroup]="mainForm">
  <div class="main-container">
    <mat-expansion-panel class="history-container">
      <mat-expansion-panel-header>
        <mat-panel-title class="history-title">
          Tooth history
        </mat-panel-title>
      </mat-expansion-panel-header>
      <div #historyBar class="history-bar">
        @for (toothHist of toothHistory; track $index) {
        <div class="history-tooth" [class.current]="toothHist.odontogram === tooth().odontogram"
          [class.active]="selectedTooth?.odontogram === toothHist.odontogram" (click)="selectTooth(toothHist)"
          (keydown.enter)="selectTooth(toothHist)" tabindex="0">
          <span class="odontogram-name" [title]="toothHist.odontogram?.name">
            {{ toothHist.odontogram?.name ?? 'Actual' }}
          </span>
          <div class="tooth-container">
            <lib-odontogram-single-tooth-image [tooth]="toothHist"
              [showNumber]="false"></lib-odontogram-single-tooth-image>
          </div>
        </div>
        @if (!$last) {
        <span class="tooth-separator">
          <i class="fas fa-arrow-right"></i>
        </span>
        }
        }
      </div>
    </mat-expansion-panel>
    <div class="form-container">
      @if (!treatmentsForm.disabled) {
      <mat-form-field>
        <input type="text" placeholder="Search a treatment" matInput [matAutocomplete]="autoCompleteTreatment"
          [(ngModel)]="treatmentSearchTerm" [ngModelOptions]="{ standalone: true }" tabIndex="1">
      </mat-form-field>
      <mat-autocomplete class="product-search" #autoCompleteTreatment="matAutocomplete"
        (optionSelected)="addTreatment($event.option.value)">
        @for (option of treatmentSuggestions; track $index) {
        <mat-option [value]="option">{{option.name}}</mat-option>
        }
      </mat-autocomplete>
      }
      @if (!tooth()) {
      <div class="loading d-flex justify-content-center align-items-center">
        <i class="fas fa-circle-notch fa-spin fa-2x"></i>
      </div>
      }
      @if (tooth() && treatmentsForm) {
      <div class="treatments" formArrayName="treatments">
        @for (treatment of treatmentsForm.controls; track $index; let i = $index) {
        <div class="treatment"
          [ngClass]="toothTreatmentStatusToCssClass[treatment.get('status')?.value || toothTreatmentStatus.PENDING]"
          [formGroup]="treatment">
          <div class="treatmentCol align-items-center">
            <ng-container formGroupName="producto">
              <input type="text" class="form-control" formControlName="ref" readonly>
            </ng-container>
            <div class="zone-selector" [class]="treatment.get('status')?.value ?? 'pending'"
              [class.pointer-events-none]="treatmentsForm.disabled"
              [class.disabled]="treatment.get('type')?.value === 'implant' || treatment.get('type')?.value === 'extraction'">
              <div class="main-zones">
                @for (zone of [toothZones.TOP, toothZones.LEFT, toothZones.CENTER, toothZones.RIGHT, toothZones.BOTTOM];
                track $index) {
                <div mat-ripple [class]="zone" [class.selected]="treatment.get('zones')?.value?.includes(zone)"
                  (click)="toggleZone(treatment, zone)" (keydown.enter)="toggleZone(treatment, zone)" tabindex="2">
                </div>
                }
              </div>
              <div class="lateral-raiz">
                @for (zone of [toothZones.LATERAL, toothZones.ROOT]; track $index) {
                <div mat-ripple [class]="zone" [class.selected]="treatment.get('zones')?.value?.includes(zone)"
                  (click)="toggleZone(treatment, zone)" (keydown.enter)="toggleZone(treatment, zone)" tabindex="2">
                </div>
                }
              </div>
            </div>
          </div>
          <div class="treatmentCol secondCol">
            <div class="d-flex">
              <ng-container formGroupName="treatment">
                <input name="name" type="text" class="form-control nombre" formControlName="name"
                  placeholder="Treatment name" tabindex="3">
                <!-- <div class="precioVenta">
                    <input type="number" class="form-control" formControlName="precioVenta" step="0.01">
                </div> -->
              </ng-container>
              @if (!treatmentsForm.disabled) {
              <button mat-icon-button (click)="removeTreatment(i)" (keydown.enter)="removeTreatment(i)" tabIndex="4">
                <i class="fas fa-trash text-danger"></i>
              </button>
              }
            </div>
            <div class="treatment-info">
              <div class="d-flex column-gap-05">
                <div class="affected-teeth">
                  <mat-form-field tabindex="5">
                    <mat-label>Teeth</mat-label>
                    <mat-select formControlName="teeth" multiple>
                      @for (tooth of teeth(); track $index) {
                      <mat-option [value]="tooth.number" [disabled]="tooth.disabled">{{tooth.number}}</mat-option>
                      }
                    </mat-select>
                  </mat-form-field>
                </div>
                <div class="groupTeeth">
                  <mat-button-toggle-group #groupLotes="matButtonToggleGroup" formControlName="groupTeeth">
                    <mat-button-toggle [value]="true">Grouped</mat-button-toggle>
                    <mat-button-toggle [value]="false">Individual</mat-button-toggle>
                  </mat-button-toggle-group>
                </div>
                <div class="status" [class.pointer-events-none]="treatmentsForm.disabled">
                  <div [class.active]="treatment.get('status')?.value === toothTreatmentStatus.PENDING"
                    (click)="setStatus(treatment, toothTreatmentStatus.PENDING)"
                    (keydown.enter)="setStatus(treatment, toothTreatmentStatus.PENDING)" tabindex="2">
                    <i class="fas fa-square pending"></i>
                    <span>Pending</span>
                  </div>
                  <div [class.active]="treatment.get('status')?.value === toothTreatmentStatus.COMPLETED"
                    (click)="setStatus(treatment, toothTreatmentStatus.COMPLETED)"
                    (keydown.enter)="setStatus(treatment, toothTreatmentStatus.COMPLETED)" tabindex="2">
                    <i class="fas fa-square finished"></i>
                    <span>Completed</span>
                  </div>
                </div>
              </div>
              <div class="notes">
                <textarea class="form-control" formControlName="additionalInformation"
                  placeholder="Notes about the treatment"></textarea>
              </div>
            </div>
          </div>
        </div>
        }
      </div>
      }
    </div>
  </div>
</div>
